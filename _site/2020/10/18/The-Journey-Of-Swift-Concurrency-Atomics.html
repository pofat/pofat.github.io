<!-- åšæ–‡çš„å¸ƒå±€-Layout -->
<!DOCTYPE html>
<html>
<head>
<!-- å¼•å…¥headæ ‡ç­¾ -->
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-sclable=0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="description" content="#0x8badf00d ğŸ¤®" />
<meta name="keywords" content="iOS, Swift" />
<link rel="stylesheet" href="/assets/css/style.css">
<link rel="stylesheet" href="/assets/css/media.css">
<link rel="stylesheet" href="/assets/css/animate.min.css">
<link rel="stylesheet" href="/assets/css/pygments/pygments_pastie.css">
<link rel="stylesheet" href="/assets/css/github-markdown.css">
<!-- SNS-icon -->
<script src="//at.alicdn.com/t/font_856428_y9z6nq7zf5.js"></script>
<!-- share.css -->
<link rel="stylesheet" href="/assets/css/share.min.css">
<!-- font -->
<link rel="stylesheet" href="/assets/css/font.css">
<!-- <link href="https://fonts.googleapis.com/css?family=Kaushan+Script|Pacifico|Ubuntu|Roboto+Mono|Source+Sans+Pro" rel="stylesheet"> -->

<!-- Favicon -->
<link href="/assets/profile.jpeg" rel="shortcut icon" />
<link href="/assets/profile.jpeg" rel="apple-touch-icon-precomposed" />
<!-- Android Lolipop Theme Color -->
<!-- <meta name="theme-color" content="#1464FB"> -->
<title>The Journey Of Swift Concurrency - Atomics</title>
<!-- ç™¾åº¦ç»Ÿè®¡ -->

<!-- è°·æ­Œåˆ†æ -->

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-141693863-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-141693863-1');
</script>


<!-- Android Lolipop Theme Color -->
<meta name="theme-color" content=" rgb(253,117,36) ">
</head>
<body>

<!-- é¡¶éƒ¨é”šç‚¹ -->
<a id="htmlup" name="htmlup"></a>
<!-- å¼•å…¥åšæ–‡é¡¶éƒ¨é€‰é¡¹ -->

<header id="post-header" style="background-color:rgb(253,117,36);">
  <div class="top-center">
      <div class="logo">
          <a href="/" title="my awesome webtitle" style="color: white;">Pofat Develops</a>
      </div>
      <nav class="top-nav">
          <ul>
              
                <li><a href="/" style="color: white;">Articles</a></li>
              
                <li><a href="/tags.html" style="color: white;">Tags</a></li>
              
                <li><a href="/timeline.html" style="color: white;">Timeline</a></li>
              
                <li><a href="/about.html" style="color: white;">About</a></li>
              
          </ul>
      </nav>
      <div id="top-boot">
        <a href="javascript:;" id="boot1" style="display:block;" onclick="document.getElementById('boot-area').style.display='block';document.getElementById('boot1').style.display='none';document.getElementById('boot2').style.display='block';"><img src="/assets/boot_white.png" alt=""></a>
        <a href="javascript:;" id="boot2" style="display: none;" onclick="document.getElementById('boot-area').style.display='none';document.getElementById('boot1').style.display='block';document.getElementById('boot2').style.display='none';"><img src="/assets/boot_white.png" alt=""></a>
      </div>
  </div>

</header>


<!-- å¼•å…¥ç§»åŠ¨ä¸‹æ‹‰é€‰é¡¹ -->
<div id="boot-area">
    <ul>
        
          <a href="/"><li>Articles</li></a>
        
          <a href="/tags.html"><li>Tags</li></a>
        
          <a href="/timeline.html"><li>Timeline</li></a>
        
          <a href="/about.html"><li>About</li></a>
        
    </ul>
</div>

<!-- å¼•å…¥åšæ–‡é¡¶éƒ¨æ ·å¼ -->
<!-- ç‰ˆæœ¬ä¸€ åƒåœ¾ -->
<!-- <div class="wow fadeIn top" data-wow-duration="3.5s" >
    <span class="wow fadeInUp" data-wow-delay="0.2s">The Journey Of Swift Concurrency - Atomics</span>
    <span class="wow fadeInUp" data-wow-delay="0.4s"></span>
    <span class="wow fadeInUp" data-wow-delay="0.4s"></span>
    <span class="wow fadeInUp" data-wow-delay="0.6s">ä½œè€…&nbsp;&nbsp;|&nbsp;&nbsp;Pofat</span>
</div> -->

<!-- ç‰ˆæœ¬äºŒ å¯åˆ‡æ¢é¡µé¢ -->

<div class="post-top" style="background-color:rgb(253,117,36);">
  <!-- é¡µé¢å®½åº¦å¤§äº800px -->
  <div class="left-area">
    
      <a href="javascript:;" class="btn bounceInLeft animated" onmouseover="showLeft();this.style.color='rgb(253,117,36)';" onmouseout="goneLeft();this.style.color='rgba(0,0,0,.2)';"><</a>
      <div id="left-tab" style="display:none;"><span class="left-san"></span><span class="left-main" style="color:rgb(253,117,36);"><sapn class="main">åˆ°é ‚äº†</sapn></span></div>
    
  </div>
  <div class="post-titlearea">
    <span class="wow fadeInUp" data-wow-delay="0.2s">The Journey Of Swift Concurrency - Atomics</span>
    <!-- <span class="wow fadeInUp" data-wow-delay="0.4s"></span> -->
    <!-- <span class="wow fadeInUp" data-wow-delay="0.4s"></span> -->
    <!-- <span class="wow fadeInUp" data-wow-delay="0.6s">ä½œè€…&nbsp;&nbsp;|&nbsp;&nbsp;Pofat</span> -->
  </div>
  <div class="right-area">
    
      <a href="/2020/09/29/pofats-chat-room-iplayground.html" class="btn bounceInRight self-animated" onmouseover="showRight();this.style.color='rgb(253,117,36)';" onmouseout="goneRight();this.style.color='rgba(0,0,0,.2)';">></a>
      <div id="right-tab" style="display:none;"><span class="right-san"></span><span class="right-main" style="color:rgb(253,117,36);"><sapn class="main">æ³¢è‚¥çš„è»Ÿå·¥ç›¸è«‡å®¤ @ iPlayground</sapn></span></div>
    
  </div>

  <!-- é¡µé¢å®½åº¦å°äº800px -->
  <div class="post-changearea">
    
      <a href="javascript:;" class="leftchange" style="border-right: 1px solid rgb(253,117,36);border-bottom: 2px solid rgb(253,117,36);"><span><br>åˆ°é ‚äº†</span></a>
    
    
      <a href="/2020/09/29/pofats-chat-room-iplayground.html" class="rightchange" style="border-left: 1px solid rgb(253,117,36);border-bottom: 2px solid rgb(253,117,36);"><span>ä¸‹ä¸€ç¯‡<br><br>æ³¢è‚¥çš„è»Ÿå·¥ç›¸è«‡å®¤ @ iPlayground</span></a>
    
  </div>
</div>


<div class="markdown-body fadeInUp animated">

  

  <!-- æ–‡ç« å†…å®¹ -->
  <p>ç”±æ–¼åœ¨ weak self <a href="https://weakself.dev/episodes/56">56é›†</a>èŠåˆ°äº†é€™é™£å­ Apple ä¸€å‘¨ä¸€ frameworkï¼Œè“¬å‹ƒåœ°ç”¢å‡º<del>Bug</del>ï¼Œæˆ‘èªç‚ºé€™å€‹ <a href="https://github.com/apple/swift-atomics">Swift Atomics</a> æ˜¯æ•´å€‹ Swift Concurrency å¤§æ¥­çš„ä¸€å€‹åˆ†æ”¯ï¼Œä¹‹å¾Œæœƒé™¸çºŒå°±æˆ‘çš„çœ‹æ³•ï¼Œå°‡  Swift Concurrency çš„èµ·é ­ï¼Œä»¥åŠç›®å‰å·²ç¶“å¯¦ç¾çš„éƒ¨åˆ†å¯«æ–‡æ¢è¨ã€‚æœ¬ä¾† Atomics æ‡‰è©²æ˜¯æ•´å€‹ç³»åˆ—çš„ç¬¬ä¸‰æˆ–ç¬¬å››é›†ï¼Œä½†å› ç‚º Podcast ç¯€ç›®è¦å‡ºäº†ï¼Œè¿«åœ¨çœ‰ç«ã€è¤²å­è‘—ç«ï¼Œåªå¥½å…ˆèŠ Atomics ï¼ˆç–‘åˆæ˜¯ç¬¬ä¸‰é›†å…ˆå‡ºå•Š)ï¼Œä¹Ÿæ”¾æ£„äº† Integer å‹åˆ¥çš„ç³»åˆ— indexï¼Œä»¥å¢åŠ <del>æƒ¡è£œçš„å¯èƒ½æ€§</del>å½ˆæ€§ã€‚</p>

<h2 id="ç‚ºä½•è¦æœ‰-swift-atomics">ç‚ºä½•è¦æœ‰ Swift Atomics?</h2>

<p>ç›¸ä¿¡ iOS é–‹ç™¼è€…éƒ½å¾ˆç†Ÿæ‚‰ï¼Œå¦‚æœè¦åœ¨ä¸åŒçš„ thread é–“è®€å¯«å…±äº«çš„è®Šæ•¸ï¼Œç‰¹åˆ¥æ˜¯ value type å¦‚ <code class="highlighter-rouge">Array</code> æˆ– <code class="highlighter-rouge">Dictionary</code>ï¼Œæˆ‘å€‘éƒ½æœƒç”¨å€‹ GCD queue é™åˆ¶è®€å¯«éƒ½åªåœ¨åŒä¸€å€‹ queue ä¸Šæˆ–è€…ç”¨ <code class="highlighter-rouge">NSLock</code> ä¹‹é¡çš„ lock ä¾†ä¿è­‰è®€å¯«é †åºèˆ‡å®Œæ•´æ€§ã€‚</p>

<p>ç„¶è€Œå° Swift è€Œè¨€ï¼Œå¸Œæœ›èƒ½æˆç‚ºç³»çµ±å±¤ç´šå¯ä½¿ç”¨çš„èªè¨€ä»¥åŠå…·æœ‰æ›´é«˜å±¤æ¬¡æŠ½è±¡çš„ Concurrency åšæ³•ï¼ˆæ¯”å¦‚ Coroutinesï¼‰ï¼Œéœ€è¦æ›´åº•å±¤çš„ç•Œé¢è®“é–‹ç™¼è€…èƒ½å¤ ç›´æ¥å®£å‘Šä¸€å€‹å¯ä»¥å®‰å…¨è¨ªå•çš„åŒæ­¥çµæ§‹ã€‚</p>

<p>ç°¡è€Œè¨€ä¹‹å°±æ˜¯ä½ èƒ½å®£å‘Šä¸€å€‹å‹åˆ¥ï¼Œå°±å¯ä»¥ç›´æ¥åœ¨ä¸åŒçš„ thread é–“è®€å¯«å®ƒè€Œä¸æœƒå‡ºäº‹ï¼Œä½ ä¸éœ€è¦å†å»è€ƒæ…®è©²ç”¨ GCD æˆ– lock ä¾†ä¿è­‰å®ƒçš„å®‰å…¨æ€§ï¼Œç•¢ç«Ÿé€™å…©ç¨®æ–¹æ³•éƒ½æœ‰å®ƒçš„ç¼ºé»èˆ‡é™åˆ¶ï¼š</p>

<p>ä½¿ç”¨ GCDï¼Œç•¶æ•¸æ“šæˆ–å°è±¡å¢åŠ æ™‚ï¼Œå®¹æ˜“è®Šå¾—è¤‡é›œï¼Œä½ å¾ˆé›£ä¸€ä¸‹æ˜ç™½æ˜¯ã€Œå“ªä¸€å€‹ queueã€åœ¨ä¿è­·ã€Œå“ªä¸€å€‹æ•¸æ“šã€ï¼› æœ‰çš„æƒ…æ³ä½¿ç”¨ NSLockæ ¹æœ¬ç„¡ç”¨ï¼Œæ¯”å¦‚åœ¨ä¸€å€‹ mutating method è£¡æ”¾ lockï¼Œmutating æœ¬èº«å¯¦ä½œæ¦‚å¿µæ˜¯æœƒå…ˆ copy ä¸€ä»½å‡ºå»ä¿®æ”¹ï¼Œå†å¯«å›åŸæœ¬çš„è®Šæ•¸ä¸­ã€‚é™¤ä»¥æ­¤å¤–ï¼Œlock çš„åšæ³•å¯èƒ½é‚„æœƒæœ‰æ•ˆèƒ½çš„ç–‘æ…®ã€‚</p>

<p>æ‰€ä»¥ï¼ŒSwift æ‡‰è©²æå€‹è‡ªå·±çš„æ±è¥¿è®“æˆ‘å€‘ç›´æ¥ç”¨æ‰å°ï¼ŒåŸºæœ¬ä¸Šç›®æ¨™æœƒæ˜¯ï¼š</p>

<ul>
  <li>ä¸€å€‹æ–°çš„é¡å‹ï¼Œæœƒåœ¨èªç¾©ä¸Šæ˜é¡¯åœ°æ¨™ç¤ºé€™æ˜¯ä¸€å€‹ atomic æ“ä½œï¼Œæœ€è¦ç·Šçš„å°±æ˜¯ concurrent mutationï¼Œä¸€å€‹ Swift ä»¥å‰æ²’æœ‰çš„æ¦‚å¿µã€‚</li>
  <li>æ“ä½œæ™‚è¦æ˜ç¢ºåœ°çµ¦äºˆ memory order åƒæ•¸ï¼Œä»¥æ˜ç™½è®€å¯«å…±äº«çš„ memory æ™‚é †åºæ˜¯å¦‚ä½•åœ°ä¿è­‰ã€‚</li>
</ul>

<p>ç•¶ç„¶å¦‚åŒä»‹ç´¹èˆ‡ææ¡ˆèªªçš„ï¼Œé€™æ˜¯å€‹æ»¿æ˜¯å‘çš„é ˜åŸŸï¼Œè·Ÿ <code class="highlighter-rouge">Unsafe-</code> å®¶æ—ä¸€æ¨£ï¼Œå¸Œæœ›å°‘ç”¨æ›´æˆ–è€…åˆ¥ç”¨ã€‚é€™è£¡åªæ˜¯å¯¦ç¾äº†çœŸæ­£çš„ concurrent mutation çš„å¯èƒ½æ€§ï¼ˆå› ç‚ºä»¥å‰æ˜¯ä¸å¯èƒ½çš„ï¼‰ï¼Œå¯¦è³ªä¸Š Atomics ç‰©ä»¶å¯ä»¥è¦–ä½œ <code class="highlighter-rouge">UnsafePointer</code> çš„ wrapper è€Œå·²ï¼Œç”¨èµ·ä¾†å°±æ˜¯æ€•ã€‚</p>

<p>å¯¦éš›ä¸Šåšçš„äº‹å¤§æ¦‚æ˜¯å…©éƒ¨åˆ†ï¼š</p>

<ol>
  <li>èˆ‡ C/C++ ç›¸ä¼¼çš„åŒæ­¥è¨˜æ†¶é«”æ¨¡å‹ä»¥åŠæ©‹æ¥ C/C++çš„è¨˜æ†¶é«”é †åº</li>
  <li>åŸºæ–¼ C Atomic å¯¦ç¾æ ¸å¿ƒåŠŸèƒ½èˆ‡ class-based çš„ Atomic ç‰©ä»¶çµ¦ Swift é–‹ç™¼è€…ä½¿ç”¨</li>
</ol>

<h2 id="swift-atomics-ç‚ºä½•æ˜¯å€‹-package">Swift Atomics ç‚ºä½•æ˜¯å€‹ Package</h2>

<p>Atomics çš„ææ¡ˆæ˜¯ <a href="https://github.com/apple/swift-evolution/blob/main/proposals/0282-atomics.md">SE-0282</a>ï¼Œç„¶è€Œé€™å€‹ææ¡ˆæ˜¯ç¶“éç¿»ä¿®çš„ï¼ŒåŸæœ¬å¾åº•å±¤è¦åšçš„æ©‹æ¥ C++/C ä¹‹è¨˜æ†¶é«”æ¨¡å‹åˆ°é–‹ç™¼è€…å¯ä»¥å»ºç«‹çš„ Atomic é¡å‹éƒ½æœ‰å®šç¾©ã€‚é€™å€‹ç›®æ¨™åŸæœ¬æ˜¯å¸Œæœ›åœ¨ï¼Œä¸éåœ¨è€ƒæ…®å°æ–¼ API/ABI ç©©å®šçš„å½±éŸ¿ï¼Œæœ€å¾Œåœ¨ <a href="https://forums.swift.org/t/se-0282-low-level-atomic-operations/35382/59">Joe çš„å»ºè­°</a>ä¸‹ï¼Œé€™å€‹ææ¡ˆä¿®æ”¹ç‚ºé‡å°è¨˜æ†¶é«”æ¨¡å‹çš„æ”¹é€²å’Œèˆ‡æ­¤ç›¸é—œçš„åº•å±¤ apiï¼Œè€Œæœ€ä¸Šå±¤çš„ class-based çš„ Atomics ç‰©ä»¶å‰‡ç”¨ package ä¾†æ¨å‡ºã€‚</p>

<p>é—œæ–¼ç¬¬ä¸€ç‰ˆçš„ææ¡ˆå¯è¦‹<a href="https://github.com/apple/swift-evolution/blob/3a358a07e878a58bec256639d2beb48461fc3177/proposals/0282-atomics.md">æ­¤</a>ï¼Œæ¨å‹<a href="https://twitter.com/kemchenj">å››å¨˜</a>æœ‰é‡å°åŸå§‹ç‰ˆå¯«äº†ä¸€ç¯‡<a href="https://kemchenj.github.io/2020-10-02/">è­¯æ–‡</a>ï¼Œè‹±æ–‡è‹¦æ‰‹å¯åƒè€ƒã€‚</p>

<h2 id="æ€éº¼ç”¨">æ€éº¼ç”¨</h2>

<p>æœ€å¸¸è¦‹çš„ thread-unsafe access ä¾‹å­æ˜¯</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="kd">import</span> <span class="kt">Dispatch</span>

<span class="kd">struct</span> <span class="kt">Counter</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">value</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">mutating</span> <span class="kd">func</span> <span class="nf">increment</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">value</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">DispatchQueue</span><span class="o">.</span><span class="nf">concurrentPerform</span><span class="p">(</span><span class="nv">iterations</span><span class="p">:</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span> <span class="n">_</span> <span class="k">in</span>
    <span class="k">for</span> <span class="n">_</span> <span class="k">in</span> <span class="mi">0</span><span class="o">..&lt;</span><span class="mi">1000</span> <span class="p">{</span>
        <span class="n">counter</span><span class="o">.</span><span class="nf">increment</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nf">print</span><span class="p">(</span><span class="n">counter</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="c1">// æœƒå¾ˆå¥‡æ€ªä¸æ˜¯ 10_000</span></code></pre></figure>

<p>å¦‚æœç”¨ Atomics å°±æœƒå¾—åˆ°æ­£ç¢ºçš„çµæœ</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="kd">import</span> <span class="kt">Atomics</span>
<span class="kd">import</span> <span class="kt">Dispatch</span>

<span class="k">let</span> <span class="nv">counter</span> <span class="o">=</span> <span class="kt">ManagedAtomic</span><span class="o">&lt;</span><span class="kt">Int</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="kt">DispatchQueue</span><span class="o">.</span><span class="nf">concurrentPerform</span><span class="p">(</span><span class="nv">iterations</span><span class="p">:</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span> <span class="n">_</span> <span class="k">in</span>
  <span class="k">for</span> <span class="n">_</span> <span class="k">in</span> <span class="mi">0</span> <span class="o">..&lt;</span> <span class="mi">1000</span> <span class="p">{</span>
    <span class="n">counter</span><span class="o">.</span><span class="nf">wrappingIncrement</span><span class="p">(</span><span class="nv">ordering</span><span class="p">:</span> <span class="o">.</span><span class="n">relaxed</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="n">counter</span><span class="o">.</span><span class="nf">load</span><span class="p">(</span><span class="nv">ordering</span><span class="p">:</span> <span class="o">.</span><span class="n">relaxed</span><span class="p">)</span> <span class="c1">// âŸ¹ 10_000</span></code></pre></figure>

<h2 id="æ”¯æ´çš„å‹åˆ¥">æ”¯æ´çš„å‹åˆ¥</h2>

<ul>
  <li>å„é¡æ•´æ•¸å€‘ï¼š <code class="highlighter-rouge">Int, Int64, Int32, Int16, Int8</code> èˆ‡ <code class="highlighter-rouge">UInt, UInt64, UInt32, UInt16, UInt8</code></li>
  <li><code class="highlighter-rouge">Bool</code></li>
  <li>æ¨™æº–çš„ Pointer å‹åˆ¥ï¼š <code class="highlighter-rouge">UnsafeRawPointer, UnsafeMutableRawPointer, UnsafePointer&lt;T&gt;, UnsafeMutablePointer&lt;T&gt;, Unmanaged&lt;T&gt;</code>ï¼Œä»¥åŠå®ƒå€‘çš„ Optional å‹æ…‹</li>
  <li>ä»»ä½• <code class="highlighter-rouge">RawValue</code> æ˜¯ atomic type çš„ <code class="highlighter-rouge">RawRepresentable</code>ï¼Œæ¯”å¦‚</li>
</ul>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="kd">enum</span> <span class="kt">AtomicEnum</span><span class="p">:</span> <span class="kt">Int</span><span class="p">,</span> <span class="kt">AtomicValue</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">foo</span><span class="p">,</span> <span class="n">bar</span>
<span class="p">}</span>

<span class="k">let</span> <span class="nv">aEnum</span> <span class="o">=</span> <span class="kt">ManagedAtomic</span><span class="o">&lt;</span><span class="kt">AtomicEnum</span><span class="o">&gt;</span><span class="p">(</span><span class="o">.</span><span class="n">foo</span><span class="p">)</span></code></pre></figure>

<ul>
  <li>Reference type è¦ confrom AtomicReference protocol æ‰è¡Œï¼Œå¦‚ä¸€å€‹ LinkedList è£¡æœ€å¸¸ç”¨çš„ Node çµæ§‹</li>
</ul>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="kd">class</span> <span class="kt">Node</span><span class="p">:</span> <span class="kt">AtomicReference</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">next</span><span class="p">:</span> <span class="kt">ManagedAtomic</span><span class="o">&lt;</span><span class="kt">Node</span><span class="p">?</span><span class="o">&gt;</span>
    <span class="k">var</span> <span class="nv">value</span><span class="p">:</span> <span class="kt">Element</span><span class="p">?</span>
<span class="p">}</span></code></pre></figure>

<h2 id="å°ç¾æœ‰çš„è¡æ“Š">å°ç¾æœ‰çš„è¡æ“Š</h2>

<p>ä¸Šé¢çš„ concurrent DispatchQueue ä¾‹å­é¡¯ç„¶é•åäº†ç•¶å‰çš„ Swift memery exclusive access rules ï¼Œä¸èƒ½åŒæ™‚æœ‰ read/write æˆ– write/write accessï¼Œæ‰€ä»¥é€™å€‹è¦å‰‡è¢«æ”¹å¯«äº†ç‚º <code class="highlighter-rouge">é™¤äº† read æˆ– atomic accessï¼Œä¸å¾—æœ‰åœ¨åŒä¸€å€‹ variable ä¸Šæœ‰é‡è¤‡çš„ access</code>ï¼Œç„¶å¾Œ atomic access å°±æ˜¯æˆ‘å€‘å¯ä»¥ä½¿ç”¨çš„é€™äº› api å¦‚ <code class="highlighter-rouge">func load(ordering: AtomicLoadOrdering) -&gt; Value</code> ç­‰</p>

<p>è‡³æ–¼è¨˜æ†¶é«”ç®¡ç†ï¼Œç›®å‰æä¾›äº†å…©ç¨®å½¢æ…‹çš„ classï¼Œç•¶ç„¶é‚„æ˜¯é¼“å‹µå¤§å®¶ç”¨ ARC çš„ç‰ˆæœ¬ï¼Œé™¤éä½ å®Œå…¨çŸ¥é“è‡ªå·±åœ¨å¹¹å˜›</p>

<ul>
  <li><code class="highlighter-rouge">ManagedAtomic&lt;T&gt;</code>ï¼š ä»°è³´ ARC ç®¡ç†è¨˜æ†¶é«”</li>
  <li><code class="highlighter-rouge">UnsafeAtomic&lt;T&gt;</code>ï¼š é¡§åæ€ç¾©ï¼Œä½ è¦æ‰‹å‹•è‡ªå·±ç®¡ç†è¨˜æ†¶é«”ï¼Œå¯è¦–ç‚º UnsafePointer å†åŒ…ä¸€å±¤</li>
</ul>

<p>é€™å…©ç¨®ç‰©ä»¶éƒ½æä¾›äº†å…­ç¨®å¯ç”¨çš„æ“ä½œ</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="kd">func</span> <span class="nf">load</span><span class="p">(</span><span class="nv">ordering</span><span class="p">:</span> <span class="kt">AtomicLoadOrdering</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Value</span>
<span class="kd">func</span> <span class="nf">store</span><span class="p">(</span><span class="n">_</span> <span class="nv">desired</span><span class="p">:</span> <span class="kt">Value</span><span class="p">,</span> <span class="nv">ordering</span><span class="p">:</span> <span class="kt">AtomicStoreOrdering</span><span class="p">)</span>
<span class="kd">func</span> <span class="nf">exchange</span><span class="p">(</span><span class="n">_</span> <span class="nv">desired</span><span class="p">:</span> <span class="kt">Value</span><span class="p">,</span> <span class="nv">ordering</span><span class="p">:</span> <span class="kt">AtomicUpdateOrdering</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Value</span>

<span class="kd">func</span> <span class="nf">compareExchange</span><span class="p">(</span>
    <span class="nv">expected</span><span class="p">:</span> <span class="kt">Value</span><span class="p">,</span>
    <span class="nv">desired</span><span class="p">:</span> <span class="kt">Value</span><span class="p">,</span>
    <span class="nv">ordering</span><span class="p">:</span> <span class="kt">AtomicUpdateOrdering</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="nv">exchanged</span><span class="p">:</span> <span class="kt">Bool</span><span class="p">,</span> <span class="nv">original</span><span class="p">:</span> <span class="kt">Value</span><span class="p">)</span>

<span class="kd">func</span> <span class="nf">compareExchange</span><span class="p">(</span>
    <span class="nv">expected</span><span class="p">:</span> <span class="kt">Value</span><span class="p">,</span>
    <span class="nv">desired</span><span class="p">:</span> <span class="kt">Value</span><span class="p">,</span>
    <span class="nv">successOrdering</span><span class="p">:</span> <span class="kt">AtomicUpdateOrdering</span><span class="p">,</span>
    <span class="nv">failureOrdering</span><span class="p">:</span> <span class="kt">AtomicLoadOrdering</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="nv">exchanged</span><span class="p">:</span> <span class="kt">Bool</span><span class="p">,</span> <span class="nv">original</span><span class="p">:</span> <span class="kt">Value</span><span class="p">)</span>

<span class="kd">func</span> <span class="nf">weakCompareExchange</span><span class="p">(</span>
    <span class="nv">expected</span><span class="p">:</span> <span class="kt">Value</span><span class="p">,</span>
    <span class="nv">desired</span><span class="p">:</span> <span class="kt">Value</span><span class="p">,</span>
    <span class="nv">successOrdering</span><span class="p">:</span> <span class="kt">AtomicUpdateOrdering</span><span class="p">,</span>
    <span class="nv">failureOrdering</span><span class="p">:</span> <span class="kt">AtomicLoadOrdering</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="nv">exchanged</span><span class="p">:</span> <span class="kt">Bool</span><span class="p">,</span> <span class="nv">original</span><span class="p">:</span> <span class="kt">Value</span><span class="p">)</span></code></pre></figure>

<p>åŸºæœ¬ä¸Šé€™å€‹æ“ä½œå’Œ C/C++ æ˜¯ç›¸ä¼¼çš„ï¼Œä¸” memory ordering æ›´æ˜¯å®Œå…¨ 1:1 å°æ‡‰åˆ° C/C++ <code class="highlighter-rouge">std::memory_order</code> çš„å®šç¾©ã€‚</p>

<h2 id="lock-free-ä½†ä¸æ˜¯-wait-free">Lock-Free ä½†ä¸æ˜¯ Wait-Free</h2>

<p>Swift Atomics ä¿è­‰ç”¨é€™ç‰©ä»¶å¯ä»¥å®Œå…¨ä¸æœƒè¢«æ“‹ä½ (non-blocking)ï¼Œä½†ä¸ä»£è¡¨ä¸€å®šä¸ç”¨ç­‰ï¼Œå¯¦éš›ä¸Šçš„ atomic æ“ä½œæœƒå› å°æ‡‰çš„åŸ·è¡Œå¹³å°è€Œç•°ï¼Œå¦‚æœæ˜¯ compare and exchange loop çš„è©±ï¼Œä½ å¯èƒ½æœƒå› ç‚ºä¸åŒçš„æ’ç¨‹ç­–ç•¥è€Œéœ€è¦ç­‰æ¯”è¼ƒä¹…æ‰èƒ½å®Œæˆæ“ä½œï¼Œcompare and exchange çš„æ¦‚å¿µå¯èƒ½å¯ä»¥é€™æ¨£å¤§ç•¥è¡¨ç¤º</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="kd">func</span> <span class="nf">compareAndSwap</span><span class="p">(</span><span class="nv">old</span><span class="p">:</span> <span class="kt">Value</span><span class="p">,</span> <span class="nv">new</span><span class="p">:</span> <span class="kt">Value</span><span class="p">,</span> <span class="nv">current</span><span class="p">:</span> <span class="kt">Value</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span> <span class="p">{</span>
    <span class="k">guard</span> <span class="n">old</span> <span class="o">==</span> <span class="n">current</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">false</span>
    <span class="p">}</span>
    <span class="n">old</span> <span class="o">=</span> <span class="k">new</span> <span class="c1">// assgin new value to real address</span>
    <span class="k">return</span> <span class="kc">true</span>
<span class="p">}</span>

<span class="c1">// The loop</span>
<span class="k">repeat</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">oldValue</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="nf">load</span><span class="p">()</span> <span class="c1">// fetch old value</span>
    <span class="k">let</span> <span class="nv">newValue</span> <span class="o">=</span> <span class="n">newValue</span> <span class="c1">// value we want to set</span>
    <span class="k">let</span> <span class="nv">success</span> <span class="o">=</span> <span class="nf">compareAndSwap</span><span class="p">(</span><span class="nv">old</span><span class="p">:</span> <span class="n">oldValue</span><span class="p">,</span>
                                 <span class="nv">new</span><span class="p">:</span> <span class="n">newValue</span><span class="p">,</span>
                                 <span class="nv">current</span><span class="p">:</span> <span class="n">value</span><span class="o">.</span><span class="nf">load</span><span class="p">())</span> 
<span class="p">}</span> <span class="k">while</span> <span class="o">!</span><span class="n">success</span></code></pre></figure>

<h2 id="app-é–‹ç™¼è€…è©²æ€éº¼åš">App é–‹ç™¼è€…è©²æ€éº¼åšï¼Ÿ</h2>

<p>æ‹¿ Swift Atomics çš„å®˜æ–¹ä¾‹å­å’Œ NSLock åš increment çš„æ•ˆç‡ç²—ç•¥æ¯”è¼ƒä¸€ä¸‹(åš 10 æ¬¡å–å¹³å‡ï¼‰ï¼Œå¯ä»¥çœ‹åˆ°å·®è·</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Atomics: 2.7975
NSLock: 4.8439
</code></pre></div></div>

<p>åŸºæœ¬ä¸Šé€™å€‹ pakcage å¯èƒ½çµ•å¤§å¤šæ•¸çš„ iOS é–‹ç™¼è€…æ˜¯å®Œå…¨ç”¨ä¸åˆ°çš„ï¼Œè‡³å°‘è¦åˆ° <a href="https://github.com/belozierov/SwiftCoroutine">SwiftCoroutine</a> é€™æ¨£ç¨‹åº¦çš„ API æ‰æœ‰å¯èƒ½è¢«å¤§å®¶èˆ’æœåœ°ä½¿ç”¨çš„ï¼Œæˆ–è¨±æœ‰èˆˆè¶£çš„äººå¯ä»¥åŠ å…¥å¹«å¿™è™•ç†ä¸€äº›åº•å±¤æœªå¯¦ç¾çš„åŠŸèƒ½ï¼Œæˆ–è‘—è©¦è‘—ç”¨å®ƒæ­å»ºæ›´é«˜å±¤å¯ä»¥çµ¦ä¸€èˆ¬ app é–‹ç™¼è€…ä½¿ç”¨çš„å¥—ä»¶ã€‚</p>

<p>çœŸçš„è¦ç”¨çš„è©±ï¼Œè©¦è‘—èˆ‰å€‹ä¾‹å­ï¼Œå‡å¦‚æˆ‘å€‘æœ‰ä¸€å€‹ç‰©ä»¶æœƒè¢«å¤šå€‹ thread ä½¿ç”¨ï¼Œæˆ‘å€‘æƒ³åœ¨ä¸åŒ thread å°å®ƒåšäº‹ï¼Œä½†é€™ä»¶äº‹åªèƒ½åšä¸€æ¬¡ï¼ˆæ¯”å¦‚ clean upï¼‰ï¼Œå¯ä»¥é€™éº¼å¯«</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="kd">import</span> <span class="kt">Atomics</span>
<span class="kd">import</span> <span class="kt">Foundation</span>

<span class="kd">class</span> <span class="kt">SomeObject</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="k">let</span> <span class="nv">done</span> <span class="o">=</span> <span class="kt">ManagedAtomic</span><span class="o">&lt;</span><span class="kt">Bool</span><span class="o">&gt;</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>

    <span class="c1">// Can only clear once</span>
    <span class="kd">func</span> <span class="nf">clear</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="o">!</span><span class="n">done</span><span class="o">.</span><span class="nf">load</span><span class="p">(</span><span class="nv">ordering</span><span class="p">:</span> <span class="o">.</span><span class="n">relaxed</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">let</span> <span class="nv">expected</span> <span class="o">=</span> <span class="kc">false</span>
            <span class="k">if</span> <span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span> <span class="o">==</span> <span class="n">done</span><span class="o">.</span><span class="nf">compareExchange</span><span class="p">(</span><span class="nv">expected</span><span class="p">:</span> <span class="n">expected</span><span class="p">,</span> <span class="nv">desired</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nv">ordering</span><span class="p">:</span> <span class="o">.</span><span class="n">relaxed</span><span class="p">)</span> <span class="p">{</span>
                <span class="nf">print</span><span class="p">(</span><span class="s">"got cleared only once"</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">let</span> <span class="nv">some</span> <span class="o">=</span> <span class="kt">SomeObject</span><span class="p">()</span>

<span class="kt">DispatchQueue</span><span class="o">.</span><span class="nf">concurrentPerform</span><span class="p">(</span><span class="nv">iterations</span><span class="p">:</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span> <span class="n">_</span> <span class="k">in</span>
    <span class="n">some</span><span class="o">.</span><span class="nf">clear</span><span class="p">()</span> <span class="c1">// åªæœƒè¢« clear ä¸€æ¬¡</span>
<span class="p">}</span></code></pre></figure>


  <!-- å¼•å…¥shareæ¨¡å— -->
  
  <div class="social-share-wrapper">
    <div class="social-share"></div>
  </div>


<!-- share.js -->
<script src="/assets/js/social-share.min.js"></script>
<script>
  socialShare('.social-share', {
    sites: [
      
        'twitter'
        ,
        
      
        'facebook'
        ,
        
      
        'linkedin'
        
      
    ],
    wechatQrcodeTitle: "åˆ†äº«åˆ°å¾®ä¿¡æœ‹å‹åœˆ",
    wechatQrcodeHelper: 'æœŸå¾…åœ¨æœ‹å‹åœˆè§åˆ°è¿™ç¯‡æ–‡ç« '
  });
</script>

</div>

<!-- åº•éƒ¨é”šç‚¹ -->
<a id="htmldown" name="htmldown"></a>
<!-- å¼•å…¥è¯„è®ºæ¨¡å— -->

    <section class="post-footer-item comment">
      <div id="disqus_thread"></div>
    </section>

    <script>
      /**
       *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
       *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
      /*
      var disqus_config = function () {
      this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
      this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
      };
      */
      (function() { // DON'T EDIT BELOW THIS LINE
        var d = document,
          s = d.createElement('script');
        /*å†™å…¥è‡ªå·±çš„disqusä¿¡æ¯*/
        s.src = 'https://pofat-dev.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
      })();

    </script>







<!-- å¼•å…¥gotoæ¨¡å— -->
<div class="bounceInRight animated go">
  <a title="åˆ°æœ€ä¸Šé¢åˆ‡æ›ä¸åŒæ–‡ç« " class="gototop" href="#htmlup" target="_self">
    <div class="box" style="font-family:'Arial';">
        Top
    </div>
  </a>
  <a title="åº•éƒ¨æœ‰disqusè©•è«–" class="gotobottom" href="#htmldown" target="_self">
    <div class="box" style="font-family:'Arial';">
        Foot
    </div>
  </a>
</div>

<!-- å¼•å…¥é¡µé¢åº•éƒ¨æ¨¡å— -->
<footer id="bottom">
  <br>
  <span>Pofat Develops Â©
  
  
    2019
    -
  
  2020
  <br>
  Powered by <a href="https://www.jekyll.com.cn/">Jekyll</a> | <a href="https://github.com/xukimseven/HardCandy-Jekyll">HardCandy-Jekyll</a></span>
</footer>


<!-- å¼•ç”¨wow.jsçš„åŠ¨ç”»æ•ˆæœ -->
<script src="/assets/js/wow.js"></script>
<script>
    var wow = new WOW({
        boxClass: 'wow',
        animateClass: 'animated',
        // offset: 600,
        mobile: true,
        live: true
    });
    wow.init();
</script>
<!-- é¡µé¢åˆ·æ–°å›åˆ°é¡¶éƒ¨ -->
<script>
    window.onbeforeunload = function(){
        //åˆ·æ–°åé¡µé¢è‡ªåŠ¨å›åˆ°é¡¶éƒ¨
        document.documentElement.scrollTop = 0;  //ieä¸‹
        document.body.scrollTop = 0;  //éie
    }
</script>
<script src="/assets/js/main.js"></script>
</body>
</html>
